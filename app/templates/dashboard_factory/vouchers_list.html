{# templates/dashboard_factory/vouchers_list.html #}
{% extends "dashboard_factory/base.html" %}
{% block factory_content %}

<h2 class="mb-4">ğŸ“¦ Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ (Ù…Ø¬Ù…Ù‘ÙØ¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬)</h2>

{% if groups and groups|length > 0 %}
  {% set ns = namespace(idx=0) %}

  <div class="table-responsive shadow rounded-3 overflow-hidden">
    <table class="table table-bordered align-middle text-center mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:1%"></th>
          <th>Ø§Ù„Ø±Ù…Ø²</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
        </tr>
      </thead>

      <tbody class="table-group-divider">
      {% for g in groups %}
        {% set ns.idx = ns.idx + 1 %}
        {% set gid = 'g' ~ ns.idx %}

        {# Ø³Ø·Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ #}
        <tr class="bg-primary bg-opacity-10 fw-bold group-row" data-gid="{{ gid }}" style="cursor:pointer">
          <td>
            <button type="button" class="btn btn-sm btn-outline-primary toggle-btn" data-gid="{{ gid }}">â–¼</button>
          </td>
          <td class="text-start" colspan="4">
            {{ g.product }}
            <span class="badge bg-primary ms-2">{{ g.count }} Ø³Ù†Ø¯</span>
            <small class="text-muted ms-3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: {{ g.total_qty }}</small>
          </td>
        </tr>

        {# Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·) #}
        <tr class="detail-row d-none" data-gid="{{ gid }}">
          <td colspan="5" class="p-0">
            <div class="table-responsive m-0">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Ø§Ù„Ø±Ù…Ø²</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th class="text-start">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                  </tr>
                </thead>
                <tbody id="tbody-{{ gid }}">
                  {# â˜… Ù†Ø±Ù†Ø¯Ø± Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© #}
                  {% include 'dashboard_factory/_voucher_rows.html' with context %}
                  {# â†‘ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙŠØ­ØªØ§Ø¬ Ù…ØªØºÙŠØ± rows Ù…ÙˆØ¬ÙˆØ¯. Ù†ÙˆÙÙ‘Ø±Ù‡ Ù‡Ù†Ø§: #}
                  {% set rows = g.rows %}
                  {% include 'dashboard_factory/_voucher_rows.html' %}
                </tbody>
                {% if g.remaining > 0 %}
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-center">
                      <button
                        class="btn btn-outline-secondary btn-sm show-more"
                        data-product="{{ g.product }}"
                        data-gid="{{ gid }}"
                        data-offset="{{ LIMIT }}"   {# â˜… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ #}
                        data-limit="{{ LIMIT }}">
                        Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ ({{ g.remaining }}+)
                      </button>
                    </td>
                  </tr>
                </tfoot>
                {% endif %}
              </table>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // â˜… ØªÙÙˆÙŠØ¶ Ø§Ù„Ø­Ø¯Ø«: ÙØªØ­/Ø·ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    document.addEventListener('click', function(e) {
      const toggler = e.target.closest('.group-row, .toggle-btn');
      if (!toggler) return;
      const gid = toggler.dataset.gid || toggler.getAttribute('data-gid');
      if (!gid) return;

      const rows = document.querySelectorAll(`.detail-row[data-gid="${gid}"]`);
      rows.forEach(r => r.classList.toggle('d-none'));

      const btn  = document.querySelector(`.toggle-btn[data-gid="${gid}"]`);
      if (btn && rows.length) btn.textContent = rows[0].classList.contains('d-none') ? 'â–¼' : 'â–²';
    }, { passive: true });

    // â˜… Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" â€” ØªØ­Ù…ÙŠÙ„ ÙƒØ³ÙˆÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    document.addEventListener('click', async function(e) {
      const btn = e.target.closest('.show-more');
      if (!btn) return;

      const product = btn.dataset.product;
      const gid     = btn.dataset.gid;
      const offset  = parseInt(btn.dataset.offset, 10) || 0;
      const limit   = parseInt(btn.dataset.limit, 10)  || 20;

      // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      if (btn.disabled) return;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';

      try {
        const url = new URL('{{ url_for("factory.vouchers_list_more") }}', window.location.origin);
        url.searchParams.set('product', product);
        url.searchParams.set('offset', offset.toString());
        const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
        const html = await resp.text();

        // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const tbody = document.getElementById('tbody-' + gid);
        if (tbody) {
          const tmp = document.createElement('tbody');
          tmp.innerHTML = html;
          // Ù†Ù‚Ù„ <tr> ÙÙ‚Ø·
          Array.from(tmp.children).forEach(tr => tbody.appendChild(tr));
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø²Ø§Ø­Ø©
        btn.dataset.offset = (offset + limit).toString();

        // Ø¥Ø°Ø§ Ø±Ø¬Ø¹Øª Ø¯ÙØ¹Ø© Ø£Ù‚Ù„ Ù…Ù† limit â†’ Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„Ù…Ø²ÙŠØ¯
        const received = (html.match(/<tr/g) || []).length;
        if (received < limit) {
          btn.remove(); // Ù„Ø§ Ù…Ø²ÙŠØ¯
        } else {
          btn.disabled = false;
          btn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
        }
      } catch (err) {
        console.error(err);
        btn.disabled = false;
        btn.textContent = originalText;
        alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
      }
    });
  </script>

{% else %}
  <div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª Ø¨Ø¹Ø¯.</div>
{% endif %}

{% endblock %}
