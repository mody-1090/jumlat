{% extends "dashboard_admin/base.html" %}
{% block admin_content %}
<h2 class="mb-4">ğŸ“‘ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª{% if batch_id %} â€” Ø¯ÙØ¹Ø© Ø±Ù‚Ù… {{ batch_id }}{% endif %}</h2>

{% if total == 0 %}
  <div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù‘ÙÙ„Ø©.</div>
{% else %}

  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
    <div class="text-muted">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: {{ total }} | ØµÙØ­Ø© {{ page }} / {{ total_pages }}</div>
  </div>

  {# ØªÙØ±ÙŠØ¯ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ "ØªØ·Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ" Ù„Ù…Ù†Ø¹ Ø£ÙŠ ØªÙƒØ±Ø§Ø± Ø´ÙƒÙ„ÙŠ #}
  {% set uniq = namespace(seen_numbers={}) %}

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light text-center">
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
          <th>Ø§Ù„Ù…ØµÙ†Ø¹</th>
          {# Ø­ÙØ°Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ù†Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ #}
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø±.Ø³)</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>ØªÙ†Ø²ÙŠÙ„</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
          {# --- 1) Ø¬Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Ù… --- #}
          {% set num_raw = inv.invoice_number %}

          {# --- 2) ØªØ·Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ Ù„Ù„Ø±Ù‚Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø´ÙƒÙ„ÙŠ --- #}
          {% if num_raw %}
            {% set num = (num_raw|string).strip().upper()
                |replace(' ', '')
                |replace('â€','-') |replace('-','-') |replace('â€“','-') |replace('â€”','-')
                |replace('Ù ','0') |replace('Ù¡','1') |replace('Ù¢','2') |replace('Ù£','3') |replace('Ù¤','4')
                |replace('Ù¥','5') |replace('Ù¦','6') |replace('Ù§','7') |replace('Ù¨','8') |replace('Ù©','9')
            %}
          {% else %}
            {% set num = None %}
          {% endif %}

          {% if num %}
            {# Ø£Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ± ÙÙ‚Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠØ¹ #}
            {% if not uniq.seen_numbers.get(num) %}
              {% set _ = uniq.seen_numbers.update({num: 1}) %}
              <tr class="text-center">
                <td>{{ num_raw }}</td>
                <td>{{ inv.voucher.factory.name if inv.voucher and inv.voucher.factory else "â€”" }}</td>
                <td>{{ inv.voucher.quantity if inv.voucher else "â€”" }}</td>
                <td>{{ "%.2f"|format(inv.amount or 0) }}</td>
                <td>{{ inv.created_at.strftime("%Y-%m-%d") if inv.created_at else "â€”" }}</td>
                <td>
                  {% if inv.pdf_url %}
                    {% if inv.pdf_url.startswith('http://') or inv.pdf_url.startswith('https://') %}
                      <a href="{{ inv.pdf_url }}" target="_blank" class="btn btn-sm btn-outline-primary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„</a>
                    {% else %}
                      <a href="{{ url_for('static', filename=inv.pdf_url) }}" target="_blank" class="btn btn-sm btn-outline-primary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„</a>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% else %}
            {# Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø©: Ù†Ø¹Ø±Ø¶Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø£Ùˆ Ø§Ø­Ø°Ù Ø§Ù„ØµÙ Ø¥Ù† Ø±ØºØ¨Øª) #}
            <tr class="text-center">
              <td>â€”</td>
              <td>{{ inv.voucher.factory.name if inv.voucher and inv.voucher.factory else "â€”" }}</td>
              <td>{{ inv.voucher.quantity if inv.voucher else "â€”" }}</td>
              <td>{{ "%.2f"|format(inv.amount or 0) }}</td>
              <td>{{ inv.created_at.strftime("%Y-%m-%d") if inv.created_at else "â€”" }}</td>
              <td>
                {% if inv.pdf_url %}
                  {% if inv.pdf_url.startswith('http://') or inv.pdf_url.startswith('https://') %}
                    <a href="{{ inv.pdf_url }}" target="_blank" class="btn btn-sm btn-outline-primary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„</a>
                  {% else %}
                    <a href="{{ url_for('static', filename=inv.pdf_url) }}" target="_blank" class="btn btn-sm btn-outline-primary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„</a>
                  {% endif %}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# ==== ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ==== #}
  {% set window_size = 2 %}
  {% set start_p = page - window_size if page - window_size > 1 else 1 %}
  {% set end_p = page + window_size if page + window_size < total_pages else total_pages %}

  <nav class="mt-3" aria-label="Invoices pagination">
    <ul class="pagination justify-content-center mb-0">
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin.all_invoices', page=1, batch_id=batch_id) }}">Ø§Ù„Ø£ÙˆÙ„Ù‰</a>
      </li>
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin.all_invoices', page=page-1 if page>1 else 1, batch_id=batch_id) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      </li>

      {% if start_p > 1 %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.all_invoices', page=1, batch_id=batch_id) }}">1</a></li>
        {% if start_p > 2 %}
          <li class="page-item disabled"><span class="page-link">â€¦</span></li>
        {% endif %}
      {% endif %}

      {% for p in range(start_p, end_p + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('admin.all_invoices', page=p, batch_id=batch_id) }}">{{ p }}</a>
        </li>
      {% endfor %}

      {% if end_p < total_pages %}
        {% if end_p < total_pages - 1 %}
          <li class="page-item disabled"><span class="page-link">â€¦</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.all_invoices', page=total_pages, batch_id=batch_id) }}">{{ total_pages }}</a></li>
      {% endif %}

      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin.all_invoices', page=page+1 if page<total_pages else total_pages, batch_id=batch_id) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
      </li>
      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin.all_invoices', page=total_pages, batch_id=batch_id) }}">Ø§Ù„Ø£Ø®ÙŠØ±Ø©</a>
      </li>
    </ul>
  </nav>

{% endif %}
{% endblock %}
